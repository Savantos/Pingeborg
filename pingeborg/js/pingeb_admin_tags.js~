//Global Members
var pages = [];
var url_types = [];
var tags = [];
var layers = [];

jQuery(document).ready(function($) {
	pingeb_show_loading("");

	//load pages
	var data = {
		action: 'pingeb_get_pages'
	};

	jQuery.post(ajaxurl, data, function(response) {
		pages = JSON.parse(response);

		//load url types
		data = {
			action: 'pingeb_get_url_type'
		};

		jQuery.post(ajaxurl, data, function(response) {
			url_types = JSON.parse(response);
			alert(response);

			//load layers
			data = {
				action: 'pingeb_get_layers'
			};

			jQuery.post(ajaxurl, data, function(response) {
				layers = JSON.parse(response);

				//load tags
				data = {
					action: 'pingeb_get_tags',
					layer_id: -1,
					marker_name: '-1',
					page_id: -1
				};

				jQuery.post(ajaxurl, data, function(response) {
					tags = JSON.parse(response);
					prepareUI();
					pingeb_build_tag_list();
					pingeb_hide_loading();
				});
			});
		});
	});	
});

function prepareUI(){
	//fill comboxes with pages
	var cmbBatchTagPage = document.getElementById('pingeb_batch_tag_page');
	var cmbFilterPage = document.getElementById('pingeb_filter_page');
	var pagesOptions = "";

	for(var i = 0; i < pages.length; i++){
		pagesOptions += "<option value='" + pages[i]['id'] + "'>" + pages[i]['title'] + "</option>"
	}

	cmbBatchTagPage.innerHTML += pagesOptions;
	cmbFilterPage.innerHTML += pagesOptions;

	//fill comboxes with layers
	var cmbFilterLayer = document.getElementById('pingeb_filter_layer');
	var layerOptions = "";

	for(var i = 0; i < layers.length; i++){
		layerOptions += "<option value='" + layers[i]['id'] + "'>" + layers[i]['name'] + "</option>"
	}

	cmbFilterLayer.innerHTML += layerOptions;
}

function pingeb_build_tag_list(){
	var html = "";
	var tagList = document.getElementById('pingeb_admin_tag_list');

	//header
	html +="<div class='pingeb-table-header'>";
	html +="<div class='pingeb-table-header-col' style='border-right:1px solid #a4a4a4;'>Id</div>";
	html +="<div class='pingeb-table-header-col' style='border-right:1px solid #a4a4a4;border-left:1px solid #a4a4a4;'>Maker Id</div>";
	html +="<div class='pingeb-table-header-col' style='border-right:1px solid #a4a4a4;border-left:1px solid #a4a4a4;'>Marker Name</div>";
	html +="<div class='pingeb-table-header-col' style='border-right:1px solid #a4a4a4;border-left:1px solid #a4a4a4;'>Layer</div>";
	html +="<div class='pingeb-table-header-col' style='border-right:1px solid #a4a4a4;border-left:1px solid #a4a4a4;'>Position</div>";
	html +="<div class='pingeb-table-header-col' style='border-right:1px solid #a4a4a4;border-left:1px solid #a4a4a4;'>Geofence Radius</div>";
	html +="<div class='pingeb-table-header-col' style='border-right:1px solid #a4a4a4;border-left:1px solid #a4a4a4;'>Urls</div>";
	html +="<div class='pingeb-table-header-col' style='border-left:1px solid #a4a4a4;'>Redirect to</div>";
	html +="</div>";

	//tags
	for(var i = 0; i < tags.length; i++){
		html +="<div class='pingeb-table-row'>";
		html +="<div class='pingeb-table-col-mm'><center>" + tags[i]['id'] + "</center></div>";
		html +="<div class='pingeb-table-col-mm'><center>" + tags[i]['marker_id'] + "</center></div>";
		html +="<div class='pingeb-table-col-mm'>" + tags[i]['name'] + "</div>";
		html +="<div class='pingeb-table-col-mm'>" + tags[i]['layer_name'] + "</div>";
		html +="<div class='pingeb-table-col-mm'>" + tags[i]['lat'] + " / " + tags[i]['lng'] + "</div>";

		html +="<div class='pingeb-table-col'>";
		html +="<center><input type='number' onblur='pingeb_set_radius(" + tags[i]['id'] + ")' id='pingeb_tag_radius_" + tags[i]['id'] + "' size='3' min='20' max='250' value='20'></center>";
		html +="</div>";

		html +="<div class='pingeb-table-col'>";
		html +="<nobr>";
		html +="<select id='pingeb_tag_url_add_type_" + tags[i]['id'] + "' size='1'>";
		for(var k = 0; k < url_types.length; k++){
			html += "<option value='" + url_types[k]['id'] + "'>" + url_types[k]['name'] + "</option>";
		}
		html +="</select>";
		html +="&nbsp;<input type='text' size='12'  id='pingeb_tag_new_url_" + tags[i]['id'] + "'>";
		html +="&nbsp;<input onclick='pingeb_random_url(" + tags[i]['id'] + ")'type='button' id='pingeb_tag_new_url_btn_" + tags[i]['id'] + "' value='random url'>";
		html +="&nbsp;<input onclick='pingeb_add_url(" + tags[i]['id'] + ")' type='button' id='pingeb_tag_url_add_" + tags[i]['id'] + "' value='add'>";
		html +="</nobr>";
		html +="<hr>";
		html +="<ul style='list-style-type:none;'>";
		html +="<li>";
		html +="<div style='width:30%;float:left;text-align:left;'>NFC</div>";
		html +="<div style='width:40%;float:left;text-align:left;'><b>/abcde</b></div>";
		html +="<div style='width:30%;float:left;text-align:left;'><a href='#'><b>remove</b></a></div>";
		html +="</li>";
		html +="</ul>";
		html +="</div>";

		html +="<div class='pingeb-table-col'>";
		html +="<select id='pingeb_tag_page_" + tags[i]['id'] + "' onchange='pingeb_set_redirect(" + tags[i]['id'] + ")' size='1'>";
		html +="<option value='-1'>Select a page</option>";
		for(var j = 0; j < pages.length; j++){
			if(tags[i]['page_id'] == pages[j]['id']){
				html += "<option value='" + pages[j]['id'] + "' selected>" + pages[j]['title'] + "</option>";
			} else {
				html += "<option value='" + pages[j]['id'] + "'>" + pages[j]['title'] + "</option>";
			}
		}
		html +="</select>";
		html +="</div>";

		html +="</div>";
	}

	//table footer
	html +="<div class='pingeb-table-header'>";
	html +="<div class='pingeb-table-header-col'>&nbsp;</div>";
	html +="<div class='pingeb-table-header-col'>&nbsp;</div>";
	html +="<div class='pingeb-table-header-col'>&nbsp;</div>";
	html +="<div class='pingeb-table-header-col'>&nbsp;</div>";
	html +="<div class='pingeb-table-header-col'>&nbsp;</div>";
	html +="<div class='pingeb-table-header-col'>&nbsp;</div>";
	html +="<div class='pingeb-table-header-col'>&nbsp;</div>";
	html +="<div class='pingeb-table-header-col'>&nbsp;</div>";
	html +="</div>";

	tagList.innerHTML = html;
}
